<!DOCTYPE html>
<html ng-app="recorderApp">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Audio Recorder</title>
    
    <script src="http://cdnjs.cloudflare.com/ajax/libs/angular.js/1.3.7/angular.min.js"></script>
    
    <script src="http://gbrlgrct.com/lib/libvorbis.js"></script>
    <script src="js/encoderWAV.js"></script>
    <script src="js/encoderOGG.js"></script>
    <script src="js/audio.js"></script>
    
    <script>

angular
  .module('recorderApp', []);

angular
  .module('recorderApp')
  .controller('MainController', function ($scope, $sce) {
    var captureControl = null;
    
    $scope.urls = [];
    
    $scope.record = function () {
      getAudioStream().then(function (stream) {
        captureControl = beginAudioCapture(stream, 4096 * 2);
      });
    };
    
    $scope.stop = function () {
      var data = captureControl.stop();
      
      var blob = encodeAudioCaptureOGG(data, 0.4);
      var url = URL.createObjectURL(blob);
      
      // Chrome for Android BUG workaround
      // need to "download" the local blob
      downloadBlob(url).then(function (blob) {
        var url = URL.createObjectURL(blob);
        
        // Angular stuff
        url = $sce.trustAsResourceUrl(url);
        
        $scope.$apply(function () {
          $scope.urls.push(url);
        });
      });
    };
  });

    </script>
  </head>
  <body ng-controller="MainController">
    <button ng-click="record()">Record</button>
    <br><br>
    <button ng-click="stop()">Stop</button>
    <br><br>
    <p ng-repeat="url in urls">
      <audio ng-src="{{url}}" controls></audio>
      <a href="{{url}}">{{url}}</a>
    </p>
  </body>
</html>